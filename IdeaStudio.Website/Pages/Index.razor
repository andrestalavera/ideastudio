@page "/"
@page "/andres-talavera-resume"
@using IdeaStudio.Website.Models
@using IdeaStudio.Website.Services
@using IdeaStudio.Website.Shared
@using Markdig
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using System.Text.Json
@inject ILazyLoadingService LazyLoadingService
@inject IAnimationService AnimationService
@inject ISeoService SeoService
@inject IJSRuntime JSRuntime
@inject ILoggerFactory LoggerFactory
@inject NavigationManager NavigationManager

<HeroComponent Introduction="@aboutMe?.Introduction" Languages="@aboutMe?.Languages" />

<section id="about" class="py-5">
	<div class="container">
		@if (aboutMe is not null && aboutMe.Cards is not null)
		{
			<div class="row g-4">
				@foreach (var (card, index) in aboutMe.Cards.Select((c, i) => (c, i)))
				{
					<CardComponent Title="@card.Title" Index="@index">
						<Content>
							@if (card.Paragraphs is not null)
							{
								@foreach (var paragraph in card.Paragraphs)
								{
									<p class="lead text-primary">@((MarkupString)Markdown.ToHtml(paragraph))</p>
								}
							}
							else
							{
								<PlaceholderComponent />
							}
							@if (card.Icons is not null)
							{
								<div class="d-flex flex-wrap gap-2">
									@foreach (var icon in card.Icons)
									{
										<i class="fas @icon me-2 fa-3x" aria-hidden="true"></i>
									}
								</div>
							}
							@if (card.Images is not null)
							{
								<div class="d-flex flex-wrap gap-2">
									@foreach (var image in card.Images)
									{
										<img src="images/@image" alt="Card image" class="img-fluid"
											style="max-width: 60px; max-height: 60px;" />
									}
								</div>
							}
						</Content>
					</CardComponent>
				}
			</div>
		}
		else
		{
			<PlaceholderComponent />
		}
	</div>
</section>

<section id="experiences" class="py-5">
    <div class="container">
        <SectionComponent Title="Professional experiences" />

        @if (experiences?.Items != null && experiences.Items.Any())
        {
            <div class="row g-4">
                @foreach (var (experience, index) in experiences.Items.Select((e, i) => (e, i)))
                {
                    <div class="col-12 @GetExperienceDisplayClass(index)" id="@($"experience-wrapper-{index}")">
                        <ExperienceComponent
                            Id="@($"experience-{index}")"
                            Title="@experience.Title"
                            Index="@index"
                            Company="@experience.Company"
                            Mode="@experience.Mode"
                            StartDate="@experience.StartDate"
                            EndDate="@experience.EndDate"
                            Locations="@experience.Locations"
                            Description="@experience.Description"
                            Responsibilities="@experience.Responsibilities"
                            Skills="@experience.Skills" />
                    </div>
                }
            </div>

            @if (GetHiddenExperiencesCount() > 0)
            {
                <div class="row">
                    <div class="col-12 text-center mt-4">
                        <button class="btn btn-light bg-opacity-50 bg-acrylic-2 @(isToggling ? "disabled" : "")"
                                @onclick="ToggleExperiencesVisibility"
                                disabled="@isToggling">
                            @if (isToggling)
                            {
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span>Updating...</span>
                            }
                            else if (showAllExperiences)
                            {
                                <span>Show only 3 latest experiences</span>
                            }
                            else
                            {
                                <span>Show @GetHiddenExperiencesCount() more experiences</span>
                            }
                        </button>
                    </div>
                </div>
            }
        }
        else
        {
            <PlaceholderComponent />
        }
    </div>
</section>

<section id="trainings" class="py-5 d-print-none">
	<div class="container">
		<SectionComponent Title="I have conducted training courses for..." />

		@if (trainingCenters?.Items != null && trainingCenters.Items.Any())
		{
			<div class="row g-4">
				@foreach (var (trainingCenter, index) in trainingCenters.Items.Select((t, i) => (t, i)))
				{
					<CardComponent Title="@trainingCenter.Name">
						<Content>
							@if (trainingCenter.Courses != null)
							{
								<div class="mb-3">
									<div class="d-flex flex-wrap gap-2">
										@foreach (var course in trainingCenter.Courses)
										{
											<span class="badge bg-acrylic text-primary rounded-pill px-3 py-2 mb-1 me-1">
												<i class="fas fa-graduation-cap me-2" aria-hidden="true"></i>
												@course
											</span>
										}
									</div>
								</div>
							}

							@if (trainingCenter.Locations != null)
							{
								@foreach (string location in trainingCenter.Locations)
								{
									<span class="badge bg-acrylic text-primary rounded-pill px-3 py-2 mb-1 me-1">
										<i class="fas fa-map-marker-alt me-2 text-primary" aria-hidden="true"></i>
										@location
									</span>
								}
							}
						</Content>
					</CardComponent>
				}
			</div>
		}
		else
		{
			<div class="row g-4">
				@for (int i = 0; i < 6; i++)
				{
					<div class="col-lg-6">
						<PlaceholderComponent />
					</div>
				}
			</div>
		}
	</div>
</section>

<section id="contact" class="py-5">
	<div class="container">
		<ContactComponent />
	</div>
</section>

@code {
	private AboutMe? aboutMe;
	private Experiences? experiences;
	private TrainingCenters? trainingCenters;
	private bool showAllExperiences = false;
	private bool isToggling = false;
	private const int DefaultExperiencesToShow = 3;

	protected override async Task OnInitializedAsync()
	{
		await AnimationService.InitializeAnimationsAsync();

		Task<AboutMe?> aboutMeTask = LazyLoadingService.LoadDataAsync<AboutMe>("data/aboutme.json");
		Task<Experiences?> experiencesTask = LazyLoadingService.LoadDataAsync<Experiences>("data/experiences.json");
		Task<TrainingCenters?> trainingCentersTask =
		LazyLoadingService.LoadDataAsync<TrainingCenters>("data/trainingcenters.json");

		await Task.WhenAll(aboutMeTask, experiencesTask, trainingCentersTask);

		aboutMe = await aboutMeTask;
		experiences = await experiencesTask;
		trainingCenters = await trainingCentersTask;
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await JSRuntime.InvokeVoidAsync("initializeScrollSpy");
			StateHasChanged();
		}
	}

	private async Task ToggleExperiencesVisibility()
	{
		if (isToggling || experiences?.Items == null) return;

		isToggling = true;

		if (showAllExperiences)
		{
			// Collapsing: gradually hide experiences and scroll to 3rd item
			await HideExtraExperiences();
		}
		else
		{
			// Expanding: gradually show more experiences
			await ShowAllExperiences();
		}

		showAllExperiences = !showAllExperiences;
		isToggling = false;
	}

	private async Task ShowAllExperiences()
	{
		var experienceItems = experiences!.Items!;

        for (int i = DefaultExperiencesToShow; i < experienceItems.Count(); i++)
        {
            var experienceId = SeoService.GenerateId($"experience-{i}");
            await JSRuntime.InvokeVoidAsync("toggleExperienceVisibility", experienceId, true);

            // Small delay for smooth animation
            await Task.Delay(100);
        }
	}

	private async Task HideExtraExperiences()
	{
		var experienceItems = experiences!.Items!;

        // First scroll to the 3rd experience (latest to show)
        if (experienceItems.Count() >= DefaultExperiencesToShow)
        {
            var thirdExperienceId = SeoService.GenerateId($"experience-{DefaultExperiencesToShow - 1}");
            await JSRuntime.InvokeVoidAsync("scrollToElement", thirdExperienceId);
            await Task.Delay(300); // Wait for scroll animation
        }

        // Then hide extra experiences
        for (int i = DefaultExperiencesToShow; i < experienceItems.Count(); i++)
        {
            var experienceId = SeoService.GenerateId($"experience-{i}");
            await JSRuntime.InvokeVoidAsync("toggleExperienceVisibility", experienceId, false);

            await Task.Delay(50);
        }
	}

    private string GetExperienceDisplayClass(int index)
    {
        // Show first 3 experiences by default, hide others
        if (index < DefaultExperiencesToShow)
        {
            return "d-flex d-print-flex"; // Always visible
        }
        else
        {
            return "d-none d-print-flex"; // Hidden by default, visible when printed
        }
    }

    private int GetHiddenExperiencesCount()
    {
        return Math.Max(0, (experiences?.Items?.Count() ?? 0) - DefaultExperiencesToShow);
    }

	private string? GetExperienceId(int index)
	{
		if (experiences?.Items == null || index >= experiences.Items.Count())
			return null;

		var experience = experiences.Items.ElementAt(index);
		return $"experience-{index}"; // or use your SEO service to generate ID
	}

	private RenderFragment<(string Title, string? Icon)> Badge => (skill) =>
	{
		return @<span class="badge text-bg-light text-primary bg-light bg-opacity-50 me-2 mb-2 d-inline-flex align-items-center">
		@if (!string.IsNullOrEmpty(skill.Icon))
		{
				<i class="fa-duotone fa-light @skill.Icon me-1" aria-hidden="true"></i>
		}
			<span>@skill.Title</span>
		</span>;
	};
}
